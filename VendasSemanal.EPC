import subprocess
import sys
import tkinter as tk
from tkinter import simpledialog
import pywhatkit as kit
import datetime

# FunÃ§Ã£o para coletar valores permitindo ponto e vÃ­rgula
def ask_float_with_comma(title, prompt):
    value = simpledialog.askstring(title, prompt)
    if value:
        value = value.replace(",", ".")  # Substitui vÃ­rgula por ponto
        try:
            return float(value)
        except ValueError:
            print(f"Erro ao converter '{value}' para nÃºmero.")
            return ask_float_with_comma(title, prompt)  # Pergunta novamente se falhar
    return 0.0

# FunÃ§Ã£o para coletar o perÃ­odo
def coletar_periodo():
    root = tk.Tk()
    root.withdraw()  
    data_inicio = simpledialog.askstring("Entrada", "Digite a data de inÃ­cio (DD/MM/YYYY):")
    data_fim = simpledialog.askstring("Entrada", "Digite a data de fim (DD/MM/YYYY):")
    return data_inicio, data_fim

# FunÃ§Ã£o para coletar dados financeiros e produtos
def coletar_informacoes_adicionais():
    num_vendas = simpledialog.askinteger("Pergunta", "Quantas vendas foram realizadas no perÃ­odo?")
    total_vendas = ask_float_with_comma("Pergunta", "Qual o valor total das vendas no perÃ­odo?")
    contas_a_pagar = ask_float_with_comma("Pergunta", "Qual o valor total das contas a pagar no perÃ­odo?")

    produtos = []
    for i in range(1, 4):
        nome = simpledialog.askstring("Produto", f"Qual o nome do {i}Âº produto mais vendido?")
        qtd = ask_float_with_comma("Produto", f"Quantos KG de {nome} foram vendidos?")
        faturamento = ask_float_with_comma("Produto", f"Qual o faturamento do produto {nome}?")
        valor_medio = faturamento / qtd if qtd > 0 else 0  # Evita divisÃ£o por zero
        produtos.append((nome, qtd, faturamento, valor_medio))

    return num_vendas, total_vendas, contas_a_pagar, produtos

# Coleta de perÃ­odo e dados adicionais
inicio_semana, fim_semana = coletar_periodo()
num_vendas, total_vendas, contas_a_pagar, produtos = coletar_informacoes_adicionais()

# Ajustando o formato das datas para UTF-8
try:
    inicio_semana = datetime.datetime.strptime(inicio_semana, "%d/%m/%Y").strftime("%d de %B de %Y")
    fim_semana = datetime.datetime.strptime(fim_semana, "%d/%m/%Y").strftime("%d de %B de %Y")
except ValueError as e:
    print(f"Erro ao formatar a data: {e}")
    exit(1)

# Processando os dados de vendas
faturamento_total = total_vendas
num_vendas_realizadas = num_vendas

# Calculando mÃ©dias
media_venda = faturamento_total / num_vendas_realizadas if num_vendas_realizadas > 0 else 0
media_diaria = faturamento_total / ((datetime.datetime.strptime(fim_semana, "%d de %B de %Y") - datetime.datetime.strptime(inicio_semana, "%d de %B de %Y")).days) if num_vendas_realizadas > 0 else 0
porcentagem_contas_a_pagar = (contas_a_pagar / faturamento_total) * 100 if faturamento_total > 0 else 0

# Gerando o relatÃ³rio detalhado
mensagem = f"""
ğŸ“Š *RelatÃ³rio de Vendas*  
ğŸ“… *PerÃ­odo:* {inicio_semana} a {fim_semana}

ğŸ’° *Faturamento Total:* R$ {faturamento_total:,.2f}
ğŸ“¦ *Vendas Realizadas:* {num_vendas_realizadas}
ğŸ’¸ *Total de Vendas:* R$ {faturamento_total:,.2f}
ğŸ’µ *MÃ©dia de Vendas por Pedido:* R$ {media_venda:,.2f}
ğŸ“† *MÃ©dia de Vendas por Dia:* R$ {media_diaria:,.2f}

ğŸ’¼ *Contas a Pagar:* R$ {contas_a_pagar:,.2f}
ğŸ’° *Porcentagem de Contas a Pagar sobre o Faturamento:* {porcentagem_contas_a_pagar:.2f}%

ğŸ” *Top 3 Produtos da Semana:*
"""

for i, (nome, qtd, faturamento, valor_medio) in enumerate(produtos, start=1):
    mensagem += f"""{i}ï¸âƒ£ {nome}  
    ğŸ”¹ *KG vendidos:* {qtd:,.2f} KG  
    ğŸ”¹ *Faturamento:* R$ {faturamento:,.2f}  
    ğŸ”¹ *Valor mÃ©dio de venda:* R$ {valor_medio:,.2f}  
    \n"""

# NÃºmero do CEO para envio via WhatsApp
numero_ceo = "+5511961704438"

# Enviar mensagem pelo WhatsApp
kit.sendwhatmsg_instantly(numero_ceo, mensagem, wait_time=15)

print("âœ… RelatÃ³rio enviado com sucesso!")
